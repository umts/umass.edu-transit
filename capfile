require 'capistrano/version'
load 'deploy' if respond_to?(:namespace) # cap2 differentiator

set :application, "transit"
set :repository,  "svn+ssh://mattmoretti@transit-dev.admin.umass.edu/usr/local/svn/public"

# If you aren't deploying to /u/apps/#{application} on the target
# servers (which is the default), you can specify the actual location
# via the :deploy_to variable:
#set :deploy_to, "/srv/#{application}"
set :oit_location, "transit/captest"
set :deploy_to, "/cwis/http/htdocs/#{oit_location}"
set :user, "transit"
set :use_sudo, false

set :deploy_via, :copy
set :copy_strategy, :export
set :copy_remote_dir, deploy_to

role :app, "webadmin.oit.umass.edu"
role :web, "webadmin.oit.umass.edu"

# Override deploy to prevent restarting
namespace :deploy do 
  task :default do
    update # task from standard cap recipe
  end

  # Override update_code to remove Rails directories
  task :finalize_update, :except => { :no_release => true } do
    run "chmod -R g+w #{latest_release}" if fetch(:group_writable, true)
  end
  
  task :setup, :except => { :no_release => true } do
    dirs = [deploy_to, releases_path, shared_path]
    dirs += %w(system log pids).map { |d| File.join(shared_path, d) }
    run "umask 02 && mkdir -p #{dirs.join(' ')}"
    
    rewrite_file = <<-EOF
      RewriteEngine On
      RewriteBase #{oit_location}/
      RewriteRule (*.) #{oit_location}/current
    EOF
    put rewrite_file, "#{deploy_to}/.htaccess" 
  end
  
  task :cold do
    default
  end
end
