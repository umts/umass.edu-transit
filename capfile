require 'capistrano/version'
load 'deploy' if respond_to?(:namespace) # cap2 differentiator

set :application, "transit"
set :repository,  "git://github.com/umts/umass.edu-transit.git"
set :scm, "git"

set :oit_location, "/transit"
set :deploy_to, "/cwis/http/htdocs#{oit_location}"
set :user, "transit"
set :use_sudo, false

set :deploy_via, :copy
set :copy_cache, true
set :build_script, "stasis"
set :copy_remote_dir, deploy_to

role :app, "webadmin.oit.umass.edu"
role :web, "webadmin.oit.umass.edu"

namespace :index do
  desc "Sets the index page of our public webpage to the one with a news feed"
  task :news do
    set :index_page, "news.html"
    link
  end
  
  desc "Sets the index page of our public webpage to the one with a slideshow"
  task :slideshow do
    set :index_page, "slideshow.html"
    link
  end

  desc <<-DESC
    Links up index.html to another file on the site.  This over-writes the \
    default index.html that's in the repository.  Probably you don't want to \
    call this one directly, but you can.  More likely, this will be called \
    by index:slideshow or index:news
  DESC
  task :link do
    begin
      run "ln -f -s #{current_path}/public/#{index_page} #{current_path}/public/index.html &&
           echo \"#{index_page}\" > #{deploy_to}/MODE"
    rescue NameError
      puts "index_page is not defined.  You probably want to run 'cap index:slideshow'\nor 'cap index:news' instead.  If you really want to link to some other\npage, sprecify the value like so:\n\n       cap index:link -s 'index_page=some_other_page.html'"
    end
  end

  desc <<-DESC
    Re-links the index.html file back to whatever location we had previously \
    used.  This is called post-deploy, and you probably won't need to call \
    it directly.
  DESC
  task :relink do
    run "ln -f -s #{current_path}/public/`cat #{deploy_to}/MODE` #{current_path}/public/index.html"
  end
end

# Overrides of default tasks:
namespace :deploy do
  desc "Deploys your project. For our non-rails app, this just calls `update'"
  task :default do
    update
    index.relink
  end

  desc "Alias for deploy.  A cold-deploy is the same as a 'warm' one for non-rails apps"
  task :cold do
    update
    index.slideshow
  end

  desc <<-DESC
    Rolls back to a previous version. This is handy if you ever \
    discover that you've deployed a lemon; `cap rollback' and you're right \
    back where you were, on the previously deployed version.
  DESC
  namespace :rollback do
    task :default do
      code
    end
  end

  desc <<-DESC
    [internal] Touches up the released code. This is called by update_code \
    after the basic deploy finishes.
    
    This task will make the release group-writable (if the :group_writable \
    variable is set to true, which is the default).
  DESC
  task :finalize_update, :except => { :no_release => true } do
    run "chmod -R g+w #{latest_release}" if fetch(:group_writable, true)
  end
  
  desc <<-DESC
    Prepares one or more servers for deployment. Before you can use any \
    of the Capistrano deployment tasks with your project, you will need to \
    make sure all of your servers have been prepared with `cap deploy:setup'. When \
    you add a new server to your cluster, you can easily run the setup task \
    on just that server by specifying the HOSTS environment variable:

      $ cap HOSTS=new.server.com deploy:setup

    It is safe to run this task on servers that have already been set up; it \
    will not destroy any deployed revisions or data.
  DESC
  task :setup, :except => { :no_release => true } do
    dirs = [deploy_to, releases_path]
    run "umask 02 && mkdir -p #{dirs.join(' ')}"
    
    #This creates a .htaccess file in the deploy directory that redirects
    #requests to the deploy directory (ie /transit) to the current release
    #directory (ie /transit/current) behind-the-scenes.  This wouldn't be
    #necisary if we had controll over the server.
    rewrite_file = <<-EOF
      RewriteEngine On
      RewriteRule ^/cwis.* #{oit_location}/ [R,L]
      RewriteRule (.*) #{oit_location}/current/public/$1
    EOF
    put rewrite_file, "#{deploy_to}/.htaccess" 
  end
  
  #Tasks available by default with Capistrano that don't do anything for us
  task :migrate do
  end
  task :migrations do
  end
  task :restart do
  end
  task :start do
  end
  task :stop do
  end
end

# vi: set filetype=ruby :
